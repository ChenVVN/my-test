{"version":3,"file":"index.js","sources":["pages/index/index.vue","../../Users/xl/Downloads/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvaW5kZXgvaW5kZXgudnVl"],"sourcesContent":["<template>\r\n  <view class=\"container\">\r\n    <view v-if=\"!isLogin\">\r\n      <button class=\"login-btn\" @tap=\"openPopup\" type=\"primary\">\r\n        微信登录\r\n      </button>\r\n    </view>\r\n\r\n    <view v-else class=\"main-page\">\r\n      <!-- 用户信息展示区 -->\r\n      <view class=\"user-card\">\r\n        <view class=\"left-info\">\r\n          <image class=\"user-avatar\" :src=\"userInfo.avatar\" mode=\"aspectFill\" />\r\n          <view class=\"user-info\">\r\n            <text class=\"user-name\">{{ userInfo.nickname || \"微信用户\" }}</text>\r\n          </view>\r\n        </view>\r\n\r\n        <view @tap=\"openPopup\">\r\n          <uni-icons type=\"compose\" size=\"20\" color=\"#666\"></uni-icons>\r\n        </view>\r\n      </view>\r\n\r\n      <!-- 功能按钮区 -->\r\n      <view class=\"function-grid\">\r\n        <view class=\"grid-item\" @tap=\"createRoom\">\r\n          <view class=\"icon-box create-room\">\r\n            <uni-icons type=\"plus\" size=\"30\" color=\"#fff\"></uni-icons>\r\n          </view>\r\n          <text class=\"grid-text\">创建房间</text>\r\n        </view>\r\n\r\n        <!-- <view class=\"grid-item\" @tap=\"backRoom\">\r\n          <view class=\"icon-box join-room\">\r\n            <uni-icons type=\"home\" size=\"30\" color=\"#fff\"></uni-icons>\r\n          </view>\r\n          <text class=\"grid-text\">返回房间</text>\r\n        </view> -->\r\n\r\n        <view class=\"grid-item\" @tap=\"openJoinPopup\">\r\n          <view class=\"icon-box scan-code\">\r\n            <uni-icons type=\"search\" size=\"30\" color=\"#fff\"></uni-icons>\r\n          </view>\r\n          <text class=\"grid-text\">进入房间</text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n\r\n    <uni-popup ref=\"joinRoomPopup\" type=\"bottom\">\r\n      <view class=\"join-box\">\r\n        <input\r\n          class=\"input\"\r\n          v-model=\"inputRoomNumber\"\r\n          placeholder=\"输入6位房间号\"\r\n          type=\"number\"\r\n        />\r\n        <button class=\"confirm-btn\" @click=\"joinRoom\">加入房间</button>\r\n      </view>\r\n    </uni-popup>\r\n\r\n    <uni-popup\r\n      ref=\"editPopup\"\r\n      type=\"bottom\"\r\n      @hide=\"handleHide\"\r\n      class=\"edit-popup\"\r\n    >\r\n      <view class=\"popup-content\">\r\n        <!-- 头像编辑区域 -->\r\n        <view class=\"avatar-section\">\r\n          <button\r\n            class=\"avatar-btn\"\r\n            open-type=\"chooseAvatar\"\r\n            @chooseavatar=\"onChooseAvatar\"\r\n            size=\"mini\"\r\n          >\r\n            <image\r\n              class=\"avatar\"\r\n              :src=\"avatarUrl || '/static/user-avatar.png'\"\r\n              mode=\"aspectFill\"\r\n            />\r\n          </button>\r\n        </view>\r\n\r\n        <!-- 昵称输入区域 -->\r\n        <input\r\n          v-model=\"nickname\"\r\n          type=\"nickname\"\r\n          class=\"nickname-input\"\r\n          placeholder=\"请输入昵称\"\r\n          placeholder-class=\"placeholder-style\"\r\n          @blur=\"onNicknameBlur\"\r\n        />\r\n\r\n        <!-- 提交按钮 -->\r\n        <button\r\n          class=\"submit-btn\"\r\n          open-type=\"getUserInfo\"\r\n          @getuserinfo=\"handleSubmit\"\r\n        >\r\n          提交信息\r\n        </button>\r\n      </view>\r\n    </uni-popup>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted } from \"vue\";\r\nimport { checkLogin, getCurrentUser } from \"@/utils/auth\";\r\nconst editPopup = ref(null); // 创建popup引用\r\n\r\nconst joinRoomPopup = ref(null); // 创建popup引用\r\n\r\nconst nickname = ref(\"\");\r\nconst avatarUrl = ref(\"/static/user-avatar.png\");\r\n\r\nconst inputRoomNumber = ref(\"\");\r\n\r\nconst userInfo = ref({});\r\nconst isLogin = ref(false);\r\n\r\nonMounted(() => {\r\n  isLogin.value = checkLogin();\r\n  console.log(checkLogin());\r\n\r\n  userInfo.value = getCurrentUser();\r\n  console.log(\"当前用户:\", userInfo);\r\n});\r\n// 弹窗关闭回调\r\nconst handleHide = () => {\r\n  console.log(\"弹窗已关闭\");\r\n};\r\nconst onChooseAvatar = (e) => {\r\n  console.log(e);\r\n\r\n  avatarUrl.value = e.detail.avatarUrl; // 获取微信返回的临时头像路径\r\n};\r\nconst onNicknameBlur = (e) => {\r\n  nickname.value = e.detail.value;\r\n};\r\n// 打开弹窗\r\nconst openPopup = () => {\r\n  nickname.value = userInfo.value.nickname; // 初始化昵称\r\n  avatarUrl.value = userInfo.value.avatar; // 初始化头像路径\r\n\r\n  editPopup.value.open(); // 通过ref调用组件方法\r\n};\r\n// 提交处理\r\n\r\nconst handleSubmit = async () => {\r\n  try {\r\n    if (!nickname.value) {\r\n      uni.showToast({\r\n        title: \"请输入昵称\",\r\n        icon: \"none\",\r\n      });\r\n      return;\r\n    }\r\n    if (avatarUrl.value === \"/static/user-avatar.png\") {\r\n      uni.showToast({\r\n        title: \"请选择头像\",\r\n        icon: \"none\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    uni.showLoading();\r\n\r\n    // 获取用户code\r\n    const loginRes = await new Promise((resolve, reject) => {\r\n      uni.login({\r\n        provider: \"weixin\",\r\n        success: resolve,\r\n        fail: reject,\r\n      });\r\n    });\r\n\r\n    let finalAvatar = avatarUrl.value;\r\n    // 仅当选择新头像时上传（排除默认头像和已上传头像）\r\n    if (\r\n      avatarUrl.value !== userInfo.value.avatar &&\r\n      !avatarUrl.value.startsWith(\"cloud:\")\r\n    ) {\r\n      const uploadRes = await uniCloud.uploadFile({\r\n        filePath: avatarUrl.value,\r\n        cloudPath: `avatars/${Date.now()}-${Math.random()\r\n          .toString(36)\r\n          .substr(2, 6)}.jpg`,\r\n      });\r\n\r\n      if (!uploadRes.fileID) throw new Error(\"头像上传失败\");\r\n      finalAvatar = uploadRes.fileID;\r\n    }\r\n\r\n    // 提交完整数据到云函数\r\n    const res = await uniCloud.callFunction({\r\n      name: \"login\",\r\n      data: {\r\n        code: loginRes.code,\r\n        nickname: nickname.value,\r\n        avatar: finalAvatar,\r\n      },\r\n    });\r\n\r\n    if (res.result.code === 0) {\r\n      // 存储到本地缓存\r\n      const userData = {\r\n        _id: res.result.data._id,\r\n        nickname: res.result.data.nickname,\r\n        avatar: res.result.data.avatar,\r\n        lastLogin: Date.now(), // 添加时间戳\r\n        expires: Date.now() + 7 * 24 * 60 * 60 * 1000, // 设置7天有效期\r\n      };\r\n      // 持久化存储到本地\r\n      uni.setStorageSync(\"userInfo\", userData);\r\n      // 同步到全局变量\r\n      getApp().globalData.userInfo = userData;\r\n\r\n      userInfo.value = getCurrentUser();\r\n      editPopup.value.close();\r\n    }\r\n    // if (res.result.code === 0) {\r\n    //   uni.showToast({ title: \"信息更新成功\" });\r\n    //   editPopup.value.close();\r\n    // } else {\r\n    //   throw new Error(res.result.msg);\r\n    // }\r\n    uni.hideLoading();\r\n  } catch (e) {\r\n    uni.showToast({\r\n      title: \"提交失败：\" + e.message,\r\n      icon: \"none\",\r\n    });\r\n  }\r\n  uni.hideLoading();\r\n};\r\n\r\nconst openJoinPopup = () => {\r\n  joinRoomPopup.value.open(); // 通过ref调用组件方法\r\n};\r\n\r\n// 加入房间校验\r\nconst validateRoomNumber = (value) => {\r\n  if (!value) return \"请输入房间号\";\r\n  if (!/^\\d{6}$/.test(value)) return \"房间号必须为6位数字\";\r\n  return true;\r\n};\r\nconst roomInfo = ref(null);\r\n// 加入房间\r\nconst joinRoom = async () => {\r\n  const valid = validateRoomNumber(inputRoomNumber.value);\r\n  if (valid !== true) {\r\n    return uni.showToast({\r\n      title: valid,\r\n      icon: \"none\",\r\n    });\r\n  }\r\n\r\n  try {\r\n    const res = await uniCloud.callFunction({\r\n      name: \"join_room\",\r\n      data: {\r\n        roomNumber: inputRoomNumber.value,\r\n        userInfo: userInfo.value,\r\n      },\r\n    });\r\n\r\n    if (res.result.code === 200) {\r\n      uni.navigateTo({\r\n        url: `/pages/room/index?room_number=${inputRoomNumber.value}`,\r\n      });\r\n    } else {\r\n      uni.showToast({\r\n        title: res.result.msg,\r\n        icon: \"none\",\r\n      });\r\n    }\r\n  } catch (e) {\r\n    uni.showToast({\r\n      title: \"加入失败\",\r\n      icon: \"none\",\r\n    });\r\n  }\r\n};\r\n\r\nconst createRoom = async () => {\r\n  uni.showLoading({\r\n    title: \"创建中\",\r\n  });\r\n  const res = await uniCloud.callFunction({\r\n    name: \"create_room\",\r\n    data: {\r\n      userInfo: userInfo.value,\r\n    },\r\n  });\r\n\r\n  uni.hideLoading();\r\n  uni.navigateTo({\r\n    url: `/pages/room/index?room_number=${res.result.data.room_number}`,\r\n  });\r\n};\r\nconst backRoom = () => {};\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.container {\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n  align-items: center;\r\n  height: 100vh;\r\n}\r\n\r\n/* 样式保持与Vue2版本一致 */\r\n.popup-content {\r\n  padding: 40rpx;\r\n  background: #fff;\r\n  border-radius: 20rpx;\r\n}\r\n\r\n.login-btn {\r\n  width: 300rpx;\r\n  /* 调整为更小的宽度 */\r\n  margin: 40rpx 0;\r\n  border-radius: 50rpx;\r\n  /* 添加圆角 */\r\n  font-size: 32rpx;\r\n  line-height: 1.5;\r\n  padding: 20rpx 0;\r\n  /* 调整内边距 */\r\n}\r\n\r\n/* 如果需要覆盖primary默认颜色 */\r\n.login-btn[type=\"primary\"] {\r\n  background-color: #07c160;\r\n}\r\n\r\n.avatar-section {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n\r\n  .avatar-desc {\r\n    color: #666;\r\n  }\r\n}\r\n\r\n.avatar-btn {\r\n  background: #fff;\r\n  border: none;\r\n  padding: 0;\r\n\r\n  &::after {\r\n    border: none;\r\n  }\r\n}\r\n\r\n.avatar {\r\n  width: 120rpx;\r\n  height: 120rpx;\r\n  border-radius: 50%;\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.edit-text {\r\n  font-size: 24rpx;\r\n  color: #666;\r\n}\r\n\r\n.nickname-input {\r\n  width: 100%;\r\n  height: 80rpx;\r\n  border: 1rpx solid #eee;\r\n  border-radius: 10rpx;\r\n  padding: 0 20rpx;\r\n  margin-bottom: 40rpx;\r\n}\r\n\r\n.submit-btn {\r\n  background: #07c160;\r\n  color: white;\r\n  border-radius: 10rpx;\r\n}\r\n\r\n.edit-popup {\r\n  width: 100%;\r\n}\r\n\r\n.main-page {\r\n  padding: 30rpx;\r\n  background: #f5f5f5;\r\n  min-height: 100vh;\r\n  width: 100%;\r\n\r\n  .user-card {\r\n    background: #fff;\r\n    padding: 40rpx 30rpx;\r\n    margin: 0 0 30rpx;\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    position: relative;\r\n    box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.05);\r\n\r\n    .left-info {\r\n      display: flex;\r\n      align-items: center;\r\n    }\r\n\r\n    .user-avatar {\r\n      width: 120rpx;\r\n      height: 120rpx;\r\n      border-radius: 50%;\r\n      margin-right: 30rpx;\r\n      border: 2rpx solid #eee;\r\n    }\r\n\r\n    .user-info {\r\n      flex: 1;\r\n      position: relative;\r\n    }\r\n\r\n    .user-name {\r\n      font-size: 36rpx;\r\n      color: #333;\r\n      font-weight: 500;\r\n      display: block;\r\n      max-width: 400rpx;\r\n    }\r\n\r\n    .grid-item {\r\n      background: #fff;\r\n      border-radius: 20rpx;\r\n      padding: 40rpx;\r\n      text-align: center;\r\n      transition: all 0.3s;\r\n\r\n      &:active {\r\n        transform: scale(0.98);\r\n        box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.1);\r\n      }\r\n    }\r\n  }\r\n\r\n  .function-grid {\r\n    display: grid;\r\n    grid-template-columns: repeat(2, 1fr);\r\n    gap: 30rpx;\r\n    padding: 0 30rpx;\r\n\r\n    .grid-item {\r\n      background: #fff;\r\n      border-radius: 20rpx;\r\n      padding: 40rpx;\r\n      text-align: center;\r\n      transition: all 0.3s;\r\n\r\n      &:active {\r\n        transform: scale(0.98);\r\n        box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.1);\r\n      }\r\n    }\r\n\r\n    .icon-box {\r\n      width: 100rpx;\r\n      height: 100rpx;\r\n      border-radius: 50%;\r\n      margin: 0 auto 20rpx;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n\r\n      &.create-room {\r\n        background: #07c160;\r\n      }\r\n\r\n      &.join-room {\r\n        background: #2979ff;\r\n      }\r\n\r\n      &.scan-code {\r\n        background: #ff9500;\r\n      }\r\n\r\n      &.edit-profile {\r\n        background: #673ab7;\r\n      }\r\n    }\r\n\r\n    .grid-text {\r\n      font-size: 30rpx;\r\n      color: #666;\r\n      display: block;\r\n    }\r\n  }\r\n}\r\n\r\n.join-box {\r\n  background: #fff;\r\n  padding: 40rpx;\r\n  border-radius: 20rpx 20rpx 0 0;\r\n\r\n  .input {\r\n    height: 100rpx;\r\n    border: 2rpx solid #eee;\r\n    border-radius: 10rpx;\r\n    padding: 0 20rpx;\r\n    margin-bottom: 30rpx;\r\n  }\r\n\r\n  .confirm-btn {\r\n    background: #07c160;\r\n    color: #fff;\r\n    border-radius: 50rpx;\r\n    height: 80rpx;\r\n    line-height: 80rpx;\r\n  }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'C:/mytest/chip/pages/index/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onMounted","checkLogin","uni","getCurrentUser","uniCloud"],"mappings":"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"}